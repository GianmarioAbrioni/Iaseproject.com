<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IASE Units Staking - IASE Project</title>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="IASE Units Staking Platform - Stake your IASE Units NFTs and earn IASE tokens" name="description"/>
  <meta name="theme-color" content="#121212">
  <meta name="author" content="IASE Project">
  
  <!-- Open Graph / Social Media Meta Tags -->
  <meta property="og:title" content="IASE Units Staking - IASE Project">
  <meta property="og:description" content="IASE Units Staking Platform - Stake your IASE Units NFTs and earn IASE tokens">
  <meta property="og:image" content="images/logo.png">
  <meta property="og:url" content="https://iaseproject.com">
  <meta property="og:type" content="website">
  
  <!-- Twitter Card data -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="IASE ‚Äì Intelligent Autonomous Space Entities">
  <meta name="twitter:description" content="A scientific project exploring distributed AI for autonomous space systems, now integrated with Web3.">
  <meta name="twitter:image" content="images/logo.png">
  
  <!-- Stile inline per nascondere il wallet dalla navbar -->
  <style>
    /* Nascondi wallet component in navbar */
    #wallet-component {
      display: none !important;
    }
    
    /* Style for dashboard loading */
    .dashboard-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .loading-container {
      text-align: center;
      padding: 2rem;
      background-color: rgba(16, 24, 39, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .loading-container p {
      color: white;
      margin-top: 1rem;
      font-size: 1.1rem;
    }
    
    /* Stili migliorati per pulsanti stake */
    .stake-btn {
      background-color: #2563eb !important;
      color: white !important;
      border: none !important;
      padding: 10px 18px !important;
      border-radius: 8px !important;
      font-weight: bold !important;
      font-size: 1.1rem !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4) !important;
      width: 100% !important;
      text-align: center !important;
      margin-top: 10px !important;
    }
    
    .stake-btn:hover {
      background-color: #1d4ed8 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 15px rgba(37, 99, 235, 0.5) !important;
    }
    
    /* Animazione pulse per attirare l'attenzione */
    @keyframes pulse-button {
      0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
    
    .stake-btn {
      animation: pulse-button 2s infinite;
    }
    
    /* Style improvements */
    .spinner-border.text-light {
      width: 3rem;
      height: 3rem;
      border-width: 0.25rem;
    }
  </style>
  
  <!-- Stylesheets -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
  <link href="menu.css" rel="stylesheet"/>
  <link href="styles.css" rel="stylesheet"/>
  <link href="css/parallax.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/staking.css">
  <link rel="stylesheet" href="css/wallet.css">
  <link rel="stylesheet" href="css/staking-wallet.css">
  
  <!-- Favicon -->
  <link href="favicon.png" rel="icon" type="image/png"/>
  
  <!-- Preconnect e preload per ottimizzare le performance -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  
  <!-- CDN Ethers diretto (garantito disponibile) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <!-- Preload CSS critici -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
  <link rel="preload" href="styles.css" as="style">
  <link rel="preload" href="css/staking.css" as="style">
</head>

<body class="staking-page">
  <!-- Header Area -->
  <header class="header-area fade-in">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-12">
          <h1 class="site-title">IASE Project</h1>
          <p class="site-description">Intelligent Autonomous Space Entities ‚Äì A Vision of Autonomous AI in Space</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <i class="ri-home-3-line"></i> IASE üõ∞Ô∏è
      </a>
      <button class="navbar-toggler" data-bs-target="#navbarContent" data-bs-toggle="collapse" type="button" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" id="projectDropdown" role="button" aria-expanded="false">
              Project
            </a>
            <ul class="dropdown-menu" aria-labelledby="projectDropdown">
              <li><a class="dropdown-item" href="project-overview.html">Overview</a></li>
              <li><a class="dropdown-item" href="technology.html">Technology &amp; Applications</a></li>
              <li><a class="dropdown-item" href="behind.html">Behind IASE</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" id="web3Dropdown" role="button" aria-expanded="false">
              Web3
            </a>
            <ul class="dropdown-menu" aria-labelledby="web3Dropdown">
              <li><a class="dropdown-item" href="web3.html">Web3 Integration</a></li>
              <li><a class="dropdown-item" href="token.html">Token</a></li>
              <li><a class="dropdown-item" href="nft.html">NFT Collection</a></li>
              <li><a class="dropdown-item active" href="staking.html">NFT Staking Platform</a></li>
              <li><a class="dropdown-item" href="roadmap.html">Roadmap</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" id="resourcesDropdown" role="button" aria-expanded="false">
              Resources
            </a>
            <ul class="dropdown-menu" aria-labelledby="resourcesDropdown">
              <li><a class="dropdown-item" href="articles.html">Articles</a></li>
              <li><a class="dropdown-item" href="publication.html">Publications</a></li>
              <li><a class="dropdown-item" href="contact.html">Contact &amp; Documents</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Logo Area -->
  <div class="logo-container animate-on-scroll fade-down">
    <div class="img-container rounded-circle mx-auto" style="width: 150px; height: 150px;">
      <img src="images/logo.png" alt="IASE Logo" width="150" height="150" class="rounded-circle">
    </div>
  </div>

  <!-- Wallet Connection Section -->
  <section class="wallet-connection-section">
    <div class="container">
      <h2 class="section-title">Connect Your Wallet</h2>
      
      <!-- Wallet Status -->
      <div class="wallet-status">
        <div class="wallet-status-indicator status-red">
          <div id="walletIndicator" class="indicator disconnected">
            <i class="ri-wallet-3-line"></i>
          </div>
          <div class="wallet-info">
            <div id="walletStatusText">Wallet not connected</div>
            <div id="walletAddress" class="wallet-address"></div>
          </div>
        </div>
        
        <div class="wallet-controls">
          <button id="connectButtonETH" class="btn primary-btn" data-network="ethereum">
            <i class="ri-plug-line"></i> Connect ETH Wallet
          </button>
          <button id="disconnectWalletBtn" class="btn secondary-btn hidden disconnect-wallet-btn" onclick="disconnectWalletETH()">
            <i class="ri-link-unlink-m"></i> Disconnect
          </button>
          
          <!-- Network Warning -->
          <div id="wrong-network-alert" class="alert alert-warning wallet-wrong-network d-none mt-3" style="font-size: 0.9rem;">
            <i class="ri-alert-line me-1"></i>
            <span>For NFT staking, you need to be on the Ethereum Mainnet network.</span>
            <button id="switch-network-btn" class="btn btn-sm btn-warning mt-2 switch-network-btn" data-chain="0x1">Switch to Ethereum</button>
          </div>
        </div>
        
        <!-- Rimosso avviso rete duplicato -->
      </div>
      
      <!-- Authentication Section for Non-Authenticated Users -->
      <div id="authSection" class="auth-section hidden">
        <div class="auth-tabs">
          <button class="auth-tab-btn active" data-tab="login">Login</button>
          <button class="auth-tab-btn" data-tab="register">Register</button>
        </div>
        
        <div class="auth-tab-content">
          <!-- Login Form -->
          <div id="loginTab" class="auth-form-container active">
            <form id="loginForm" class="auth-form">
              <div class="form-group">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" name="username" required>
              </div>
              <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" name="password" required>
              </div>
              <button type="submit" class="btn primary-btn">Login</button>
            </form>
          </div>
          
          <!-- Register Form -->
          <div id="registerTab" class="auth-form-container">
            <form id="registerForm" class="auth-form">
              <div class="form-group">
                <label for="registerUsername">Username</label>
                <input type="text" id="registerUsername" name="username" required>
              </div>
              <div class="form-group">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" name="password" required>
              </div>
              <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
              </div>
              <button type="submit" class="btn primary-btn">Register</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Staking Dashboard Section -->
  <section id="stakingDashboard" class="staking-dashboard hidden">
    <div class="container">
      <div class="dashboard-header">
        <h2 class="section-title">Staking Dashboard</h2>
        <div class="dashboard-summary">
          <div class="summary-card">
            <div class="summary-icon">
              <i class="ri-stack-line"></i>
            </div>
            <div class="summary-info">
              <h3>Staked NFTs</h3>
              <p id="totalStakedNfts">0</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon">
              <i class="ri-coin-line"></i>
            </div>
            <div class="summary-info">
              <h3>Total Rewards</h3>
              <p id="totalRewards">0 IASE</p>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon">
              <i class="ri-line-chart-line"></i>
            </div>
            <div class="summary-info">
              <h3>Daily Rewards</h3>
              <p id="dailyRewards">0 IASE</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="dashboard-tabs">
        <button class="tab-btn active" data-tab="staked">Staked NFTs</button>
        <button class="tab-btn" data-tab="available">Available NFTs</button>
        <button class="tab-btn" data-tab="rewards">Rewards</button>
      </div>
      
      <div class="tab-content active" id="stakedTab">
        <div id="stakedNftsContainer" class="nft-grid">
          <!-- Staked NFTs will be displayed here -->
          <div class="empty-state">
            <i class="ri-space-ship-line"></i>
            <h3>No Staked NFTs Found</h3>
            <p>You don't have any staked NFTs yet. Connect your wallet and stake your IASE Units to start earning rewards.</p>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="availableTab">
        <div id="availableNftsContainer" class="nft-grid">
          <!-- Available NFTs will be displayed here -->
          <div class="empty-state">
            <i class="ri-nft-line"></i>
            <h3>No Available NFTs Found</h3>
            <p>You don't have any IASE Units NFTs in your wallet. Acquire IASE Units from secondary markets to participate in staking.</p>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="rewardsTab">
        <div class="rewards-summary">
          <div class="pending-rewards">
            <h3>Pending Rewards</h3>
            <div class="reward-amount" id="pendingRewards">0 IASE</div>
            <button id="claimAllBtn" class="btn primary-btn" disabled>
              <i class="ri-coin-line"></i> Claim All Rewards
            </button>
          </div>
        </div>
        
        <div class="rewards-history">
          <h3>Rewards History</h3>
          <div class="rewards-table-container">
            <table class="rewards-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>NFT ID</th>
                  <th>Reward Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="rewardsHistoryBody">
                <!-- Rewards history will be displayed here -->
              </tbody>
            </table>
            
            <div id="rewardsEmptyState" class="empty-state">
              <i class="ri-history-line"></i>
              <h3>No Rewards History</h3>
              <p>You haven't earned any rewards yet. Stake your IASE Units to start earning IASE tokens.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How It Works Section -->
  <section class="how-it-works-section">
    <div class="container">
      <div class="section-header text-center mb-5 fade-up animate-on-scroll">
        <h2 class="section-title">How IASE Units Staking Works</h2>
        <p class="lead">Earn IASE tokens by staking your NFTs</p>
      </div>
      
      <div class="staking-process">
        <div class="process-step">
          <div class="step-number">1</div>
          <div class="step-icon">
            <i class="ri-wallet-3-line"></i>
          </div>
          <h3>Connect Wallet</h3>
          <p>Connect your Ethereum wallet that holds IASE Units NFTs</p>
        </div>
        
        <div class="process-step">
          <div class="step-number">2</div>
          <div class="step-icon">
            <i class="ri-nft-line"></i>
          </div>
          <h3>Stake NFTs</h3>
          <p>Select and stake the IASE Units you want to earn rewards from</p>
        </div>
        
        <div class="process-step">
          <div class="step-number">3</div>
          <div class="step-icon">
            <i class="ri-time-line"></i>
          </div>
          <h3>Earn Rewards</h3>
          <p>Accumulate IASE tokens daily based on your staked NFTs</p>
        </div>
        
        <div class="process-step">
          <div class="step-number">4</div>
          <div class="step-icon">
            <i class="ri-coin-line"></i>
          </div>
          <h3>Claim Rewards</h3>
          <p>Withdraw your earned IASE tokens to your wallet anytime</p>
        </div>
      </div>
      
      <div class="staking-rewards-info">
        <h3>IASE Units Staking Rewards</h3>
        <p>Each IASE Unit NFT earns rewards based on its rarity tier. The reward system is designed to provide sustainable and valuable returns to NFT holders.</p>
        
        <div class="rewards-grid">
          <div class="reward-card">
            <div class="rarity-badge standard">Standard</div>
            <h4>Standard</h4>
            <p><strong>33.33 IASE</strong> tokens per day</p>
          </div>
          
          <div class="reward-card">
            <div class="rarity-badge advanced">Advanced</div>
            <h4>Advanced</h4>
            <p><strong>50 IASE</strong> tokens per day</p>
          </div>
          
          <div class="reward-card">
            <div class="rarity-badge elite">Elite</div>
            <h4>Elite</h4>
            <p><strong>66.67 IASE</strong> tokens per day</p>
          </div>
          
          <div class="reward-card">
            <div class="rarity-badge prototype">Prototype</div>
            <h4>Prototype</h4>
            <p><strong>83.33 IASE</strong> tokens per day</p>
          </div>
        </div>
        
        <div class="staking-note">
          <i class="ri-information-line"></i>
          <p>Your NFTs must remain in your wallet for the duration of the staking period. If you sell or transfer an NFT, it will be automatically unstaked and you'll only receive rewards for the time it was staked.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="faq-section">
    <div class="container">
      <div class="section-header text-center mb-5 fade-up animate-on-scroll">
        <h2 class="section-title">Frequently Asked Questions</h2>
        <p class="lead">Answers to common questions about IASE Units staking</p>
      </div>
      
      <div class="faq-container">
        <div class="faq-item">
          <div class="faq-question">
            <h3>What are IASE Units?</h3>
            <div class="faq-toggle">
              <i class="ri-add-line"></i>
            </div>
          </div>
          <div class="faq-answer">
            <p>IASE Units are unique NFTs that represent autonomous space entities within the IASE ecosystem. Each unit has different attributes and rarity tiers, which determine their staking rewards.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h3>What wallet can I use?</h3>
            <div class="faq-toggle">
              <i class="ri-add-line"></i>
            </div>
          </div>
          <div class="faq-answer">
            <p>You can use any Ethereum-compatible wallet that supports NFTs, such as MetaMask, Trust Wallet, or Coinbase Wallet. Make sure your wallet is connected to the Ethereum mainnet.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h3>What happens if I sell my NFT?</h3>
            <div class="faq-toggle">
              <i class="ri-add-line"></i>
            </div>
          </div>
          <div class="faq-answer">
            <p>If you sell or transfer an NFT that is currently staked, it will be automatically unstaked during the next verification cycle (which occurs daily). You will receive rewards only for the period it was staked in your wallet.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h3>How is the rarity of an NFT determined?</h3>
            <div class="faq-toggle">
              <i class="ri-add-line"></i>
            </div>
          </div>
          <div class="faq-answer">
            <p>Rarity is determined by the combination of traits and attributes each IASE Unit possesses. The rarity tiers are Standard, Advanced, Elite, and Prototype, with Prototype being the rarest. These traits are recorded on the blockchain and cannot be altered.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h3>How often are rewards distributed?</h3>
            <div class="faq-toggle">
              <i class="ri-add-line"></i>
            </div>
          </div>
          <div class="faq-answer">
            <p>Rewards accumulate daily but are not automatically distributed. You can claim your rewards at any time through the staking dashboard. The system verifies NFT ownership daily at midnight UTC.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <div class="faq-question">
            <h3>Are there any fees for staking?</h3>
            <div class="faq-toggle">
              <i class="ri-add-line"></i>
            </div>
          </div>
          <div class="faq-answer">
            <p>There are no platform fees for staking your IASE Units. However, blockchain transactions such as claiming rewards will require gas fees paid in ETH, as these are standard Ethereum network fees.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer Area -->
  <footer class="footer-area">
    <div class="main-footer-area">
      <div class="container">
        <div class="row justify-content-between">
          <div class="col-12 col-md-6">
            <div class="footer-widget">
              <p>¬© 2025 IASE Project ‚Äì All Rights Reserved</p>
              <div class="social-links mt-4">
                <a href="https://www.reddit.com/r/IASEproject" target="_blank" aria-label="Reddit">
                  <i class="ri-reddit-fill"></i>
                </a>
                <a href="https://medium.com/@iaseproject" target="_blank" aria-label="Medium">
                  <i class="ri-medium-fill"></i>
                </a>
                <a href="https://x.com/iase_project" target="_blank" aria-label="X (Twitter)">
                  <i class="ri-twitter-x-fill"></i>
                </a>
                <a href="https://t.me/IASEcommunity" target="_blank" aria-label="Telegram">
                  <i class="ri-telegram-fill"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="footer-widget">
              <div class="footer-links">
                <div class="d-flex justify-content-end">
                  <a href="privacy-policy.html" class="me-4">Privacy Policy</a>
                  <a href="cookie-policy.html">Cookie Policy</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modals -->
  <!-- Stake Modal -->
  <div id="stakeModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeStakeModal">&times;</span>
      <h2>Stake IASE Unit</h2>
      
      <div class="modal-body">
        <div class="nft-preview">
          <img id="stakeNftImage" src="images/placeholder-nft.jpg" alt="NFT Preview">
          <div class="nft-info">
            <h3 id="stakeNftTitle">IASE Unit #ID</h3>
            <p id="stakeNftId">Token ID: </p>
            <div id="stakeNftRarity" class="rarity-badge standard">Standard</div>
          </div>
        </div>
        
        <div class="reward-preview">
          <h4>Reward Information</h4>
          <div class="reward-amounts">
            <div class="reward-item">
              <span>Daily Reward:</span>
              <strong id="stakeNftDailyReward">33.33 IASE</strong>
            </div>

          </div>
          <p class="note">Note: Rewards are distributed daily based on your NFT's rarity tier.</p>
        </div>
        
        <div class="modal-actions">
          <button id="confirmStakeBtn" class="btn primary-btn">
            <i class="ri-check-line"></i> Confirm Stake
          </button>
          <button id="cancelStakeBtn" class="btn outline-btn">
            <i class="ri-close-line"></i> Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Unstake Modal -->
  <div id="unstakeModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeUnstakeModal">&times;</span>
      <h2>Unstake IASE Unit</h2>
      
      <div class="modal-body">
        <div class="nft-preview">
          <img id="unstakeNftImage" src="images/placeholder-nft.jpg" alt="NFT Preview">
          <div class="nft-info">
            <h3 id="unstakeNftTitle">IASE Unit #ID</h3>
            <p id="unstakeNftId">Token ID: </p>
            <div id="unstakeNftRarity" class="rarity-badge standard">Standard</div>
          </div>
        </div>
        
        <div class="reward-preview">
          <h4>Current Rewards</h4>
          <div class="reward-amounts">
            <div class="reward-item">
              <span>Accumulated Rewards:</span>
              <strong id="unstakeNftRewards">0 IASE</strong>
            </div>
            <div class="reward-item">
              <span>Staking Since:</span>
              <strong id="unstakeNftStakingTime">--</strong>
            </div>
          </div>
          <p class="note">Warning: Unstaking will claim all accumulated rewards automatically.</p>
        </div>
        
        <div class="modal-actions">
          <button id="confirmUnstakeBtn" class="btn warning-btn">
            <i class="ri-logout-box-line"></i> Unstake & Claim
          </button>
          <button id="cancelUnstakeBtn" class="btn outline-btn">
            <i class="ri-close-line"></i> Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer">
    <!-- Notifications will be added here dynamically -->
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="js/webp-detect.js"></script>
  <!-- Script critici per la UI iniziale -->
  <script src="js/image-loader.js"></script>
  <script src="js/space-background.js"></script>
  <script src="js/parallax.js"></script>
  
  <!-- Configurazione dati reali - HARDCODED PER RENDER -->
  <script>
    // Configurazione API keys
    window.ALCHEMY_API_KEY = "uAZ1tPYna9tBMfuTa616YwMcgptV_1vB"; // Nuova API key Alchemy
    window.INFURA_API_KEY = "84ed164327474b4499c085d2e4345a66"; // Mantenuta per retrocompatibilit√†
    
    // Indirizzi smart contract
    window.NFT_CONTRACT_ADDRESS = "0x8792beF25cf04bD5B1B30c47F937C8e287c4e79F"; 
    window.REWARDS_CONTRACT_ADDRESS = "0x38C62fCFb6a6Bbce341B41bA6740B07739Bf6E1F";
    
    // Fallback Endpoints RPC
    window.ETHEREUM_RPC_FALLBACK = "https://rpc.ankr.com/eth";
    window.BSC_RPC_FALLBACK = "https://bsc-dataseed.binance.org";
    
    // Flag per debug e diagnostica
    window.IASE_DEBUG = true;
    window.ENABLE_FALLBACK_SYSTEM = true;
  </script>
  
  <!-- ethers.js direttamente da CDN per garantire caricamento -->
  <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js"></script>
  
  <!-- Backup locale di ethers.js in caso di problemi con CDN -->
  <script>
    // Verifica se ethers √® stato caricato correttamente dalla CDN
    if (typeof ethers === 'undefined') {
        console.error("‚ö†Ô∏è ethers.js non caricato correttamente");
        alert("Error: ethers.js library not loaded. Please refresh the page or check your internet connection.");
    } else {
        console.log("‚úÖ ethers.js v" + (ethers.version || "5.x") + " loaded successfully from CDN");
    }
  </script>
  
  <!-- System di fallback per caricamento NFT diretto -->
  <script src="js/direct-blockchain-api.js"></script>
  <script src="js/staking-fallback.js"></script>
  
  <!-- Script principali - versione ottimizzata -->
  <script src="js/nftReader.js"></script>
  <!-- Adattatore per compatibilit√† con vecchi script -->
  <script src="js/nft-reader-adapter.js"></script>
  
  <!-- Definisci window.STAKING_CONFIG prima del caricamento del modulo di staking -->
  <script>
    // Configurazione del modulo di staking
    window.STAKING_CONFIG = {
      // Se true, usa l'endpoint obsoleto con formato completo
      useObsoleteEndpoint: false,
      // Se true, abilita log dettagliati
      debug: true,
      // API Endpoint per il caricamento degli NFT in staking
      apiEndpoint: '/api',
      // Se true, usa la versione patch di staking.js
      usePatchedVersion: true,
      // Se true, mostra nei log le API chiamate
      logApi: true
    };
  </script>
  
  <!-- Script di staking caricato in modo tradizionale per massima compatibilit√† -->
  <script src="js/staking.js"></script>
  <script>
    // Aggiorna i valori di reward dopo il caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
      // Funzione per aggiornare tutti i valori di reward
      function updateAllRewards() {
        console.log("üîÑ Aggiornamento di tutti i valori di reward...");
        
        // Trova tutti gli elementi con ID che inizia con "daily-reward-"
        const rewardElements = document.querySelectorAll('[id^="daily-reward-"]');
        console.log(`üìä Trovati ${rewardElements.length} elementi reward da aggiornare`);
        
        rewardElements.forEach(element => {
          // Estrai l'ID dell'NFT dall'ID dell'elemento
          const nftId = element.id.replace('daily-reward-', '');
          
          // Trova la card NFT contenitore
          const cardElement = element.closest('.nft-card');
          if (!cardElement) return;
          
          // Trova l'elemento badge di rarit√† per determinare la rarit√†
          const rarityBadge = cardElement.querySelector('.rarity-badge');
          if (!rarityBadge) return;
          
          // Ottieni la rarit√† dal testo del badge
          const rarity = rarityBadge.textContent.trim();
          
          // Determina il valore di reward in base alla rarit√†
          let rewardValue = 33.33; // Default per Standard
          
          if (rarity.includes('Elite')) {
            rewardValue = 66.67;
          } else if (rarity.includes('Advanced')) {
            rewardValue = 50.00;
          } else if (rarity.includes('Prototype')) {
            rewardValue = 83.33;
          }
          
          // Aggiorna il testo dell'elemento
          element.textContent = `${rewardValue} IASE`;
          console.log(`‚úÖ Aggiornato reward per NFT #${nftId} (${rarity}): ${rewardValue} IASE`);
        });
      }
      
      // Esegui inizialmente e poi ogni 2 secondi per assicurarsi che tutti i valori vengano aggiornati
      // anche quando nuove card vengono caricate dinamicamente
      updateAllRewards();
      setInterval(updateAllRewards, 2000);
    });
  </script>
  
  <!-- Script connector per wallet (verificato e ottimizzato) -->
  <script src="js/staking-simple-connector.js"></script>
  
  <!-- Script non critici caricati in modo asincrono -->
  <script src="js/claim-service.js" defer></script>
  <script src="js/roadmap.js" defer></script>
  <script src="script.js" defer></script>
  <script src="js/init-chatbot.js" defer></script>
  
  <!-- UI Interaction Scripts -->
  <script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize FAQ functionality
    const faqItems = document.querySelectorAll('.faq-item');
    faqItems.forEach(item => {
        const questionEl = item.querySelector('.faq-question');
        questionEl.addEventListener('click', function() {
            item.classList.toggle('active');
        });
    });

    // Initialize Dashboard Tabs
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId + 'Tab').classList.add('active');
        });
    });

    // Initialize Auth Tabs
    const authTabButtons = document.querySelectorAll('.auth-tab-btn');
    const authFormContainers = document.querySelectorAll('.auth-form-container');
    authTabButtons.forEach(button => {
        button.addEventListener('click', function() {
            authTabButtons.forEach(btn => btn.classList.remove('active'));
            authFormContainers.forEach(container => container.classList.remove('active'));
            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId + 'Tab').classList.add('active');
        });
    });

    // Modal handling
    const stakeModal = document.getElementById('stakeModal');
    const unstakeModal = document.getElementById('unstakeModal');
    const closeStakeModal = document.getElementById('closeStakeModal');
    const closeUnstakeModal = document.getElementById('closeUnstakeModal');
    const cancelStakeBtn = document.getElementById('cancelStakeBtn');
    const cancelUnstakeBtn = document.getElementById('cancelUnstakeBtn');

    if (closeStakeModal) {
        closeStakeModal.addEventListener('click', function() {
            stakeModal.style.display = 'none';
        });
    }

    if (cancelStakeBtn) {
        cancelStakeBtn.addEventListener('click', function() {
            stakeModal.style.display = 'none';
        });
    }

    if (closeUnstakeModal) {
        closeUnstakeModal.addEventListener('click', function() {
            unstakeModal.style.display = 'none';
        });
    }

    if (cancelUnstakeBtn) {
        cancelUnstakeBtn.addEventListener('click', function() {
            unstakeModal.style.display = 'none';
        });
    }

    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === stakeModal) {
            stakeModal.style.display = 'none';
        }
        if (event.target === unstakeModal) {
            unstakeModal.style.display = 'none';
        }
    });

    // --- ATTENZIONE: Tutta la logica wallet ETH ora √® nel file staking-simple-connector.js ---
});
</script>

<!-- Rimosso caricamento duplicato di nftReader.js e approccio ES modules -->
<script>
  // Verifica che le funzioni e le configurazioni siano disponibili
  document.addEventListener('DOMContentLoaded', function() {
    console.log("üîç Verifica funzioni nftReader.js e configurazione Alchemy...");
    
    // Verifica funzioni nftReader
    if (typeof window.getUserNFTs === 'function' && 
        typeof window.getNFTMetadata === 'function' && 
        typeof window.loadAllIASENFTs === 'function') {
      console.log("‚úÖ Funzioni nftReader.js disponibili globalmente");
    } else {
      console.error("‚ùå ERRORE: Funzioni nftReader.js non disponibili");
    }
    
    // Verifica configurazione Alchemy
    console.log("üîç Verifica Alchemy API Key:", 
      window.ALCHEMY_API_KEY ? 
        `Configurata (${window.ALCHEMY_API_KEY.substring(0, 4)}...${window.ALCHEMY_API_KEY.substring(window.ALCHEMY_API_KEY.length - 4)})` : 
        "Non configurata");
    
    // Verifica configurazione NFT Contract
    console.log("üîç NFT Contract:", window.NFT_CONTRACT_ADDRESS || "Non configurato");
    
    // Verifica Direct Blockchain API
    if (window.IASEDirectBlockchainAPI) {
      console.log("‚úÖ DirectBlockchainAPI disponibile");
      console.log("üîç Provider primario:", window.IASEDirectBlockchainAPI.rpcProviders[0](window.IASEDirectBlockchainAPI.config));
    } else {
      console.log("‚ö†Ô∏è DirectBlockchainAPI non disponibile");
    }
  });
  
  async function renderNFTs() {
    await renderAvailableNFTs();
    await renderStakedNFTs();
    updateDashboardStats();
  }
  
  /**
   * Renders the available NFTs (not staked) in the available tab
   */
  async function renderAvailableNFTs() {
    const container = document.getElementById('availableNftsContainer');
    if (!container) {
      console.error("‚ùå Available NFTs container not found");
      return;
    }
    
    console.log("üîÑ Loading available NFTs...");
    container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading NFTs...</p></div>';
    
    try {
      console.log("üîÑ Calling loadAllIASENFTs()...");
      const result = await loadAllIASENFTs();
      console.log("‚úÖ loadAllIASENFTs result:", result);
      
      // Log detailed data structure
      console.log("üìä Result details:");
      console.log("- Address:", result?.address);
      console.log("- Balance:", result?.balance);
      console.log("- nftIds:", result?.nftIds);
      console.log("- nfts array:", result?.nfts);
      
      if (result?.nfts) {
        console.log("- First NFT (example):", result.nfts[0]);
      }
      
      // Get the current wallet address
      const walletAddress = window.ethereum?.selectedAddress;
      if (!walletAddress) {
        console.error("‚ùå Wallet not connected");
        container.innerHTML = `
          <div class="empty-state">
            <i class="ri-wallet-3-line"></i>
            <h3>Wallet Not Connected</h3>
            <p>Please connect your wallet to view your NFTs.</p>
          </div>`;
        return;
      }
      
      // Carica gli NFT in staking direttamente dal database
      // Questo √® il punto critico: dobbiamo usare il database invece del localStorage
      console.log("üîÑ Caricamento NFT in staking dal database per escluderli dalla lista dei disponibili");
      
      // Array per memorizzare gli ID degli NFT in staking
      let stakedTokenIds = [];
      
      try {
        // Ottieni gli NFT in staking dal database usando l'API
        const formattedAddress = walletAddress.toLowerCase();
        const response = await fetch(`/api/by-wallet/${formattedAddress}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log("‚úÖ Dati NFT in staking dal database:", data);
          
          // Estrai gli NFT in staking dalla risposta
          const stakedNfts = Array.isArray(data) ? data : (data.stakes || []);
          
          // Estrai gli ID degli NFT in staking
          stakedTokenIds = stakedNfts.map(stake => {
            // Gestisci diversi formati di ID
            if (stake.tokenId) return stake.tokenId.toString();
            if (stake.token_id) return stake.token_id.toString();
            if (stake.nft_id && stake.nft_id.includes('_')) {
              return stake.nft_id.split('_')[1].toString();
            }
            return stake.id ? stake.id.toString() : '';
          }).filter(id => id); // Rimuovi ID vuoti
        } else {
          console.warn(`‚ö†Ô∏è Errore nel caricamento degli NFT in staking: ${response.status}`);
        }
      } catch (error) {
        console.error("‚ùå Errore nel caricamento degli NFT in staking dal database:", error);
      }
      
      console.log("üîÑ Token ID in staking dal database:", stakedTokenIds);
      
      // Filter available NFTs excluding those already in staking
      let availableNfts = result.nfts || [];
      
      if (stakedTokenIds.length > 0) {
        availableNfts = availableNfts.filter(nft => {
          const nftIdAsString = nft.id.toString();
          const isStaked = stakedTokenIds.includes(nftIdAsString);
          if (isStaked) {
            console.log(`NFT #${nftIdAsString} is already staked, excluding from available list`);
          }
          return !isStaked;
        });
        console.log(`Filtered out ${result.nfts.length - availableNfts.length} staked NFTs`);
      }
      
      // Verify if there are available NFTs
      if (!availableNfts.length) {
        console.log("No NFTs available for staking");
        container.innerHTML = `
          <div class="empty-state">
            <i class="ri-nft-line"></i>
            <h3>No NFTs Available</h3>
            <p>All your IASE Units NFTs are already staked or you don't have any in your wallet yet.</p>
          </div>`;
        return;
      }
      
      container.innerHTML = ''; // Clear the container
      console.log(`Rendering ${availableNfts.length} available NFTs in the container`);
      
      // Iterate only over NFTs not already in staking
      for (const nft of availableNfts) {
        const nftElement = document.createElement('div');
        nftElement.classList.add('nft-card');
        
        // Use fields directly on the nft object
        nftElement.innerHTML = `
          <div class="nft-image">
            <img src="${nft.image}" alt="NFT #${nft.id}" loading="lazy">
          </div>
          <div class="nft-details">
            <h3 class="nft-title">NFT #${nft.id}</h3>
            <div class="nft-id">Token ID: ${nft.id}</div>
            <div class="rarity-badge ${nft.rarity?.toLowerCase() || 'standard'}">${nft.rarity || 'Standard'}</div>
            
            <div class="nft-rewards">
              <div class="reward-rate">
                <span class="reward-label">AI Booster:</span>
                <span class="reward-value">${nft['AI-Booster'] || nft.aiBooster || 'X1.0'}</span>
              </div>
              <div class="reward-rate">
                <span class="reward-label">Daily Reward:</span>
                <span id="daily-reward-${nft.id}" class="reward-value"></span>
              </div>
            </div>
            
            <div class="nft-card-actions">
              <button class="btn stake-btn" data-nft-id="${nft.id}">
                <i class="ri-login-box-line"></i> Stake
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(nftElement);
        
        // Add event listener for stake button
        const stakeBtn = nftElement.querySelector('.stake-btn');
        if (stakeBtn) {
          stakeBtn.addEventListener('click', function() {
            openStakeModal(nft.id);
          });
        }
      }
      
      console.log("‚úÖ All available NFTs have been successfully rendered");
    } catch (error) {
      console.error('Error loading available NFTs:', error);
      container.innerHTML = `
        <div class="empty-state">
          <i class="ri-error-warning-line"></i>
          <h3>Error Loading NFTs</h3>
          <p>An error occurred while loading your NFTs. Please try again later.</p>
        </div>`;
    }
  }
  
  /**
   * Renders the staked NFTs in the staked tab
   * Fetch data directly from the API instead of using localStorage
   */
  async function renderStakedNFTs() {
    const container = document.getElementById('stakedNftsContainer');
    if (!container) {
      console.error("‚ùå Staked NFTs container not found");
      return;
    }
    
    console.log("üîÑ Loading staked NFTs directly from API...");
    container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading staked NFTs...</p></div>';
    
    try {
      // Get wallet address
      const walletAddress = window.ethereum?.selectedAddress;
      if (!walletAddress) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="ri-wallet-3-line"></i>
            <h3>Wallet Not Connected</h3>
            <p>Connect your wallet to view your staked NFTs.</p>
          </div>`;
        return;
      }
      
      // Usa lo stesso metodo di staking.js per l'API
      const apiBase = `${window.location.origin}/api`;
      const url = `${apiBase}/by-wallet/${walletAddress}`;
      console.log(`üåê Fetching staked NFTs from API: ${url}`);
      
      const response = await fetch(url);
      if (!response.ok) {
        console.error(`‚ùå API error: ${response.status} ${response.statusText}`);
        container.innerHTML = `
          <div class="empty-state">
            <i class="ri-error-warning-line"></i>
            <h3>Error Loading Staked NFTs</h3>
            <p>Could not fetch your staked NFTs from the server. Please try again later.</p>
          </div>`;
        return;
      }
      
      const data = await response.json();
      const myStakedNfts = data.stakes || [];
      
      if (!myStakedNfts.length) {
        console.log("No staked NFTs found for this wallet");
        container.innerHTML = `
          <div class="empty-state">
            <i class="ri-space-ship-line"></i>
            <h3>No Staked NFTs Found</h3>
            <p>You don't have any staked NFTs yet. Stake your IASE Units to start earning rewards.</p>
          </div>`;
        return;
      }
      
      container.innerHTML = ''; // Clear the container
      console.log(`Rendering ${myStakedNfts.length} staked NFTs in the container`);
      
      // Try to get the rewards for this wallet
      let rewards = [];
      try {
        rewards = await getRewards(walletAddress);
        console.log("NFT rewards:", rewards);
      } catch (error) {
        console.error("Error loading rewards:", error);
      }
      
      // Get all NFTs to ensure we have images
      const allNftsResult = await loadAllIASENFTs();
      const allNfts = allNftsResult.nfts || [];
      
      // Render each staked NFT
      for (const stakedNft of myStakedNfts) {
        // Find reward for this NFT
        const reward = rewards.find(r => r.stakeId === stakedNft.id);
        const accumulatedReward = reward ? reward.totalReward : 0;
        
        const nftElement = document.createElement('div');
        nftElement.classList.add('nft-card', 'staked-nft');
        
        // Calculate staking duration
        const stakingStartDate = new Date(stakedNft.stakeDate);
        const now = new Date();
        const stakingDays = Math.floor((now - stakingStartDate) / (1000 * 60 * 60 * 24));
        const stakingHours = Math.floor((now - stakingStartDate) / (1000 * 60 * 60)) % 24;
        
        // Try to find the corresponding NFT in all NFTs to get image and metadata
        const matchingNft = allNfts.find(nft => nft.id.toString() === stakedNft.tokenId.toString());
        let nftImage = stakedNft.image; // Use image from staked NFT data
        
        // Get the correct rarity from matching NFT
        let rarityName = 'Standard';
        let rarityClass = 'standard';
        
        if (matchingNft && matchingNft.rarity) {
          rarityName = matchingNft.rarity;
          rarityClass = matchingNft.rarity.toLowerCase();
        } else if (stakedNft.rarity) {
          rarityName = stakedNft.rarity;
          rarityClass = stakedNft.rarity.toLowerCase();
        }
        
        // Process rarity to ensure correct capitalization for display and right class
        if (rarityClass.includes('elite')) {
          rarityName = 'ELITE';
          rarityClass = 'elite';
        } else if (rarityClass.includes('advanced')) {
          rarityName = 'ADVANCED';
          rarityClass = 'advanced';
        } else if (rarityClass.includes('prototype')) {
          rarityName = 'PROTOTYPE';
          rarityClass = 'prototype';
        }
        
        // Get AI booster value
        let aiBooster = 'X1.0';
        if (matchingNft && matchingNft['AI-Booster']) {
          aiBooster = matchingNft['AI-Booster'];
        } else if (stakedNft.metadata && stakedNft.metadata['AI-Booster']) {
          aiBooster = stakedNft.metadata['AI-Booster'];
        }
        
        // Use image from matching NFT if available, or alternative sources
        if (matchingNft && matchingNft.image) {
          nftImage = matchingNft.image;
        } else if (!nftImage) {
          // Try Alchemy NFT API format if we have an address
          nftImage = `https://nftstorage.link/ipfs/bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi/${stakedNft.tokenId}.png`;
        }
        
        nftElement.innerHTML = `
          <div class="nft-image">
            <img src="${nftImage}" alt="NFT #${stakedNft.tokenId}" loading="lazy" 
                 onerror="this.onerror=null; this.src='https://nftstorage.link/ipfs/bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi/${stakedNft.tokenId}.png';">
            <div class="staked-badge">STAKED</div>
          </div>
          <div class="nft-details">
            <h3 class="nft-title">NFT #${stakedNft.tokenId}</h3>
            <div class="nft-id">Token ID: ${stakedNft.tokenId}</div>
            <div class="rarity-badge ${rarityClass}">${rarityName}</div>
            
            <div class="staking-info">
              <div class="staking-duration">
                <span class="info-label">Staked For:</span>
                <span class="info-value">${stakingDays}d ${stakingHours}h</span>
              </div>
              <div class="reward-info">
                <span class="info-label">Rewards:</span>
                <span class="info-value">${accumulatedReward.toFixed(2)} IASE</span>
              </div>
              <div class="daily-rate">
                <span class="info-label">Daily Rate:</span>
                <span class="info-value">${stakedNft.dailyReward} IASE/day</span>
              </div>
            </div>
            
            <div class="nft-card-actions">
              <button class="btn unstake-btn primary-btn" data-token-id="${stakedNft.tokenId}" data-stake-id="${stakedNft.id}">
                <i class="ri-logout-box-line"></i> Unstake
              </button>
            </div>
          </div>
        `;
        
        container.appendChild(nftElement);
        
        // Add event listeners for unstake button
        const unstakeBtn = nftElement.querySelector('.unstake-btn');
        if (unstakeBtn) {
          unstakeBtn.addEventListener('click', function() {
            const tokenId = this.getAttribute('data-token-id');
            const stakeId = this.getAttribute('data-stake-id');
            openUnstakeModal(tokenId, stakeId);
          });
        }
      }
      
      console.log("‚úÖ All staked NFTs have been successfully rendered");
    } catch (error) {
      console.error('Error loading staked NFTs:', error);
      container.innerHTML = `
        <div class="empty-state">
          <i class="ri-error-warning-line"></i>
          <h3>Error Loading Staked NFTs</h3>
          <p>An error occurred while loading your staked NFTs. Please try again later.</p>
        </div>`;
    }
  }
  
  /**
   * Updates the dashboard statistics (total staked, rewards, etc)
   * Directly fetches data from the API instead of using localStorage
   */
  async function updateDashboardStats() {
    try {
      // Get wallet address
      const walletAddress = window.ethereum?.selectedAddress;
      if (!walletAddress) return;
      
      // Show loading indicators
      const totalStakedElement = document.getElementById('totalStakedNfts');
      const dailyRewardsElement = document.getElementById('dailyRewards');
      const totalRewardsElement = document.getElementById('totalRewards');
      
      if (totalStakedElement) totalStakedElement.textContent = "...";
      if (dailyRewardsElement) dailyRewardsElement.textContent = "...";
      if (totalRewardsElement) totalRewardsElement.textContent = "...";
      
      // Usa lo stesso metodo di staking.js per l'API
      const apiBase = `${window.location.origin}/api`;
      const url = `${apiBase}/by-wallet/${walletAddress}`;
      console.log(`üåê Fetching staked NFTs from API: ${url}`);
      
      const response = await fetch(url);
      if (!response.ok) {
        console.error(`‚ùå API error: ${response.status} ${response.statusText}`);
        return;
      }
      
      const data = await response.json();
      const myStakedNfts = data.stakes || [];
      
      // Update staked count
      if (totalStakedElement) {
        totalStakedElement.textContent = myStakedNfts.length;
      }
      
      // Calculate daily rewards
      let dailyRewardTotal = 0;
      myStakedNfts.forEach(nft => {
        let rewardRate = 33.33; // Default Standard
        const rarity = nft.rarity || 'Standard';
        
        if (rarity.includes('Elite')) {
          rewardRate = 66.67;
        } else if (rarity.includes('Advanced')) {
          rewardRate = 50.00;
        } else if (rarity.includes('Prototype')) {
          rewardRate = 83.33;
        }
        
        dailyRewardTotal += rewardRate;
      });
      
      // Update daily rewards
      if (dailyRewardsElement) {
        dailyRewardsElement.textContent = `${dailyRewardTotal.toFixed(2)} IASE`;
      }
      
      // Try to get the total accumulated rewards
      try {
        const rewards = await getRewards(walletAddress);
        let totalRewards = 0;
        rewards.forEach(reward => {
          totalRewards += reward.totalReward || 0;
        });
        
        // Update total rewards
        if (totalRewardsElement) {
          totalRewardsElement.textContent = `${totalRewards.toFixed(2)} IASE`;
        }
      } catch (error) {
        console.error("Error calculating total rewards:", error);
        if (totalRewardsElement) {
          totalRewardsElement.textContent = "0.00 IASE";
        }
      }
    } catch (error) {
      console.error("Error updating dashboard stats:", error);
    }
  }
  
  // Aggiungi listener per l'evento wallet:connected
  document.addEventListener('wallet:connected', (event) => {
    console.log("Wallet connected:", event.detail?.address);
    renderNFTs(); // Critical!
  });
  
  // Add listener for manual:loadNFTs event
  document.addEventListener('manual:loadNFTs', (event) => {
    console.log("Manual NFT loading requested");
    renderNFTs();
  });
  
  // Check if wallet is already connected when page loads
  if (window.ethereum && window.ethereum.selectedAddress) {
    renderNFTs();
  }
  
  // Funzione per aprire il modal di staking
  function openStakeModal(tokenId) {
    console.log(`üîÑ Apertura modal staking per NFT #${tokenId}`);
    
    // Ottieni il modal
    const stakeModal = document.getElementById('stakeModal');
    if (!stakeModal) {
      console.error('‚ùå Modal di staking non trovato');
      return;
    }
    
    // Imposta l'ID del token nel modal come attributo data
    stakeModal.setAttribute('data-token-id', tokenId);
    
    // Aggiorna elementi UI nel modal
    const stakeNftTitle = document.getElementById('stakeNftTitle');
    const stakeNftId = document.getElementById('stakeNftId');
    
    if (stakeNftTitle) stakeNftTitle.textContent = `IASE Unit #${tokenId}`;
    if (stakeNftId) stakeNftId.textContent = `Token ID: ${tokenId}`;
    
    // Carica l'immagine dell'NFT (se disponibile)
    const stakeNftImage = document.getElementById('stakeNftImage');
    if (stakeNftImage) {
      // Tenta di recuperare i metadati per l'immagine
      getNFTMetadata(tokenId)
        .then(metadata => {
          stakeNftImage.src = metadata.image || 'images/placeholder-nft.jpg';
          
          // Imposta anche la rarit√† se disponibile
          const stakeNftRarity = document.getElementById('stakeNftRarity');
          if (stakeNftRarity && metadata.rarity) {
            stakeNftRarity.textContent = metadata.rarity;
            stakeNftRarity.className = `rarity-badge ${metadata.rarity.toLowerCase() || 'standard'}`;
            
            // Imposta il valore del reward giornaliero in base alla rarit√†
            const dailyRewardElement = document.getElementById('stakeNftDailyReward');
            if (dailyRewardElement) {
              // Usa le costanti fisse in base alla rarit√†
              const rarityLower = metadata.rarity.toLowerCase();
              let rewardValue = 33.33; // Default per Standard
              
              if (rarityLower.includes('elite')) {
                rewardValue = 66.67; // Elite
              } else if (rarityLower.includes('advanced')) {
                rewardValue = 50.00; // Advanced
              } else if (rarityLower.includes('prototype')) {
                rewardValue = 83.33; // Prototype
              }
              
              dailyRewardElement.textContent = `${rewardValue} IASE`;
            }
          }
        })
        .catch(error => {
          console.error(`‚ùå Errore nel caricare i metadati per il modal:`, error);
          stakeNftImage.src = 'images/placeholder-nft.jpg';
        });
    }
    
    // Mostra il modal
    stakeModal.style.display = 'block';
    
    // Aggiungi event listener al pulsante di conferma
    const confirmStakeBtn = document.getElementById('confirmStakeBtn');
    const cancelStakeBtn = document.getElementById('cancelStakeBtn');
    
    // Rimuovi eventuali event listener precedenti
    if (confirmStakeBtn) {
      const newConfirmBtn = confirmStakeBtn.cloneNode(true);
      confirmStakeBtn.parentNode.replaceChild(newConfirmBtn, confirmStakeBtn);
      
      // Aggiungi il nuovo event listener
      newConfirmBtn.addEventListener('click', function() {
        confirmStakeNFT(tokenId);
      });
    }
    
    // Event listener per chiudere il modal
    if (cancelStakeBtn) {
      cancelStakeBtn.addEventListener('click', function() {
        stakeModal.style.display = 'none';
      });
    }
    
    console.log(`‚úÖ Modal di staking aperto per NFT #${tokenId}`);
  }
  
  /**
   * Conferma lo staking dell'NFT
   * @param {string} tokenId - ID del token da mettere in staking
   */
  async function confirmStakeNFT(tokenId) {
    console.log(`üîÑ Conferma staking per NFT #${tokenId}`);
    
    try {
      // Ottieni l'indirizzo del wallet
      const walletAddress = window.ethereum?.selectedAddress;
      if (!walletAddress) {
        alert('Wallet not connected. Please connect your wallet before proceeding.');
        return;
      }
      
      // Ottieni i metadati dell'NFT per la rarit√†
      const metadata = await getNFTMetadata(tokenId);
      const rarityName = metadata.rarity || 'Standard';
      
      // Determina il valore di reward in base alla rarit√†
      let rewardValue = 33.33; // Default per Standard
      if (rarityName.toLowerCase().includes('elite')) {
        rewardValue = 66.67;
      } else if (rarityName.toLowerCase().includes('advanced')) {
        rewardValue = 50.00;
      } else if (rarityName.toLowerCase().includes('prototype')) {
        rewardValue = 83.33;
      }
      
      // Prepara i dati per la chiamata API come specificato dal backend
      const stakeData = {
        address: walletAddress,
        tokenId: tokenId,
        rarityLevel: rarityName,
        dailyReward: rewardValue,
        stakeDate: new Date().toISOString()
      };
      
      // Gestisci lo staking direttamente con l'API, senza fallback locale
      // Chiamata diretta all'endpoint del database PostgreSQL
      console.log("üìä Inizio chiamata API stake al database PostgreSQL");
      
      // IMPORTANTE: Usiamo l'URL relativo per garantire che funzioni su qualsiasi dominio
      const response = await fetch(`/api/stake`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(stakeData)
      });
      
      // Se la chiamata API fallisce, mostriamo l'errore e interrompiamo
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`‚ùå Errore API staking (${response.status}):`, errorText);
        alert(`Error staking NFT: ${response.status} - Please try again later.`);
        throw new Error(`API staking error: ${response.status} - ${errorText}`);
      }
      
      console.log("‚úÖ Chiamata API stake completata con successo");
      
      const result = await response.json();
      
      // Chiudi il modal
      const stakeModal = document.getElementById('stakeModal');
      if (stakeModal) {
        stakeModal.style.display = 'none';
      }
      
      // IMPORTANTE: Reset completo della cache per forzare ricaricamento dal database
      window.stakedNftsData = null;
      window.stakedNftIds = [];
      
      // Mostra notifica di successo in inglese
      alert(`NFT #${tokenId} successfully staked! You will earn ${rewardValue} IASE tokens per day.`);
      
      // Importante: Aggiungiamo un ritardo prima di aggiornare l'interfaccia
      // per garantire che il database abbia il tempo di aggiornare i dati
      setTimeout(() => {
        console.log("üîÑ Aggiornamento dell'interfaccia dopo staking...");
        // Aggiorna la UI dopo lo staking
        renderNFTs();
        
        console.log(`‚úÖ Staking completato per NFT #${tokenId}`);
      }, 500);
    } catch (error) {
      console.error('‚ùå Errore durante lo staking:', error);
      alert(`Staking error: ${error.message}`);
    }
  }
  
  /**
   * Apre il modal di unstaking per un NFT
   * @param {string} tokenId - ID del token da rimuovere dallo staking
   * @param {object} stakeInfo - Informazioni sullo stake attuale
   */
  function openUnstakeModal(tokenId, stakeInfo) {
    console.log(`üîÑ Apertura modal unstaking per NFT #${tokenId}`);
    
    // Ottieni il modal
    const unstakeModal = document.getElementById('unstakeModal');
    if (!unstakeModal) {
      console.error('‚ùå Modal di unstaking non trovato');
      return;
    }
    
    // Imposta l'ID del token nel modal come attributo data
    unstakeModal.setAttribute('data-token-id', tokenId);
    unstakeModal.setAttribute('data-stake-id', stakeInfo.id);
    
    // Aggiorna elementi UI nel modal
    const unstakeNftTitle = document.getElementById('unstakeNftTitle');
    const unstakeNftId = document.getElementById('unstakeNftId');
    const unstakeNftRewards = document.getElementById('unstakeNftRewards');
    const unstakeNftStakingTime = document.getElementById('unstakeNftStakingTime');
    
    if (unstakeNftTitle) unstakeNftTitle.textContent = `IASE Unit #${tokenId}`;
    if (unstakeNftId) unstakeNftId.textContent = `Token ID: ${tokenId}`;
    
    // Imposta le informazioni sul reward
    if (unstakeNftRewards) {
      unstakeNftRewards.textContent = `${stakeInfo.accumulatedRewards || '0.00'} IASE`;
    }
    
    // Formatta la data di staking
    if (unstakeNftStakingTime && stakeInfo.stakeDate) {
      const stakeDate = new Date(stakeInfo.stakeDate);
      unstakeNftStakingTime.textContent = stakeDate.toLocaleDateString();
    }
    
    // Carica l'immagine dell'NFT (se disponibile)
    const unstakeNftImage = document.getElementById('unstakeNftImage');
    if (unstakeNftImage) {
      // Tenta di recuperare i metadati per l'immagine
      getNFTMetadata(tokenId)
        .then(metadata => {
          unstakeNftImage.src = metadata.image || 'images/placeholder-nft.jpg';
          
          // Imposta anche la rarit√† se disponibile
          const unstakeNftRarity = document.getElementById('unstakeNftRarity');
          if (unstakeNftRarity && metadata.rarity) {
            unstakeNftRarity.textContent = metadata.rarity;
            unstakeNftRarity.className = `rarity-badge ${metadata.rarity.toLowerCase() || 'standard'}`;
          }
        })
        .catch(error => {
          console.error(`‚ùå Errore nel caricare i metadati per il modal:`, error);
          unstakeNftImage.src = 'images/placeholder-nft.jpg';
        });
    }
    
    // Mostra il modal
    unstakeModal.style.display = 'block';
    
    // Aggiungi event listener al pulsante di conferma
    const confirmUnstakeBtn = document.getElementById('confirmUnstakeBtn');
    const cancelUnstakeBtn = document.getElementById('cancelUnstakeBtn');
    
    // Rimuovi eventuali event listener precedenti
    if (confirmUnstakeBtn) {
      const newConfirmBtn = confirmUnstakeBtn.cloneNode(true);
      confirmUnstakeBtn.parentNode.replaceChild(newConfirmBtn, confirmUnstakeBtn);
      
      // Aggiungi il nuovo event listener
      newConfirmBtn.addEventListener('click', function() {
        confirmUnstakeNFT(tokenId, stakeInfo.id);
      });
    }
    
    // Event listener per chiudere il modal
    if (cancelUnstakeBtn) {
      cancelUnstakeBtn.addEventListener('click', function() {
        unstakeModal.style.display = 'none';
      });
    }
    
    console.log(`‚úÖ Modal di unstaking aperto per NFT #${tokenId}`);
  }
  
  /**
   * Conferma l'unstaking dell'NFT e richiede il claim delle ricompense
   * @param {string} tokenId - ID del token da rimuovere dallo staking
   * @param {string} stakeId - ID dello stake nel database
   */
  async function confirmUnstakeNFT(tokenId, stakeId) {
    console.log(`üîÑ Confirming unstaking for NFT #${tokenId} (Stake ID: ${stakeId})`);
    
    try {
      // Ottieni l'indirizzo del wallet
      const walletAddress = window.ethereum?.selectedAddress;
      if (!walletAddress) {
        alert('Wallet not connected. Please connect your wallet before proceeding.');
        return;
      }
      
      // Prepara i dati per la chiamata API con la struttura corretta del database
      const unstakeData = {
        walletAddress: walletAddress,
        tokenId: tokenId,
        stakeId: stakeId,
        isActive: false,
        unstakeDate: new Date().toISOString()
      };
      
      // Effettua la chiamata API per registrare l'unstaking direttamente nel database PostgreSQL
      const response = await fetch(`/api/unstake`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(unstakeData)
      });
      
      if (!response.ok) {
        throw new Error(`Errore API: ${response.status}`);
      }
      
      const result = await response.json();
      
      // Chiudi il modal
      const unstakeModal = document.getElementById('unstakeModal');
      if (unstakeModal) {
        unstakeModal.style.display = 'none';
      }
      
      // Mostra notifica di successo
      alert(`NFT #${tokenId} successfully removed from staking! You received ${result.claimedAmount || '0.00'} IASE tokens as reward.`);
      
      // IMPORTANTE: Pulisci completamente la cache per forzare un reload dal database
      // Questo risolve il problema degli NFT che apparivano ancora in staking dopo l'unstaking
      window.stakedNftsData = null;
      window.stakedNftIds = [];
      
      // Aggiungi un ritardo prima di ricaricare gli NFT per garantire che il database sia aggiornato
      setTimeout(() => {
        // Aggiorna la UI dopo l'unstaking
        renderNFTs();
        
        console.log(`‚úÖ Unstaking completato per NFT #${tokenId}`);
      }, 500);
    } catch (error) {
      console.error('‚ùå Errore durante l\'unstaking:', error);
      alert(`Unstaking error: ${error.message}`);
    }
  }
  
  /**
   * Richiede il claim delle ricompense accumulate per un NFT in staking
   * @param {string} tokenId - ID del token per cui richiedere le ricompense
   * @param {string} stakeId - ID dello stake nel database
   */
  async function claimNFTRewards(tokenId, stakeId) {
    console.log(`üîÑ Requesting claim for NFT #${tokenId} rewards (Stake ID: ${stakeId})`);
    
    try {
      // Ottieni l'indirizzo del wallet
      const walletAddress = window.ethereum?.selectedAddress;
      if (!walletAddress) {
        alert('Wallet not connected. Please connect your wallet before proceeding.');
        return;
      }
      
      // Prepara i dati per la chiamata API nel formato corretto
      const claimData = {
        address: walletAddress,
        stakeId: stakeId,
        txHash: `claim-${Date.now()}` // Identificativo della transazione
      };
      
      // Effettua la chiamata API per registrare il claim utilizzando l'endpoint corretto che punta al database
      const response = await fetch(`/api/claim/mark-claimed`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(claimData)
      });
      
      if (!response.ok) {
        throw new Error(`Errore API: ${response.status}`);
      }
      
      const result = await response.json();
      
      // Prima ottieni il totale delle ricompense per questo stake dal database
      const rewardsResponse = await fetch(`/api/claim/rewards/${walletAddress}`);
      if (!rewardsResponse.ok) {
        throw new Error(`Errore API rewards: ${rewardsResponse.status}`);
      }
      
      const rewards = await rewardsResponse.json();
      const thisStakeReward = rewards.find(r => r.stakeId === stakeId);
      const claimedAmount = thisStakeReward ? thisStakeReward.totalReward : 0;
      
      // Mostra notifica di successo
      alert(`Rewards for NFT #${tokenId} successfully claimed! You received ${claimedAmount.toFixed(2)} IASE tokens.`);
      
      // Aggiorna la UI dopo il claim
      renderNFTs();
      
      console.log(`‚úÖ Claim completato per NFT #${tokenId} - ${claimedAmount.toFixed(2)} IASE tokens`);
    } catch (error) {
      console.error('‚ùå Errore durante il claim:', error);
      alert(`Claim error: ${error.message}`);
    }
  }
</script>
</body>
</html>